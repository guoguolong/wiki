[toc]

# 基于CRA工具链编译node_modules目录下的 ES6 模块

## 为什么：要编译node_modules目录下的 ES6 模块

在开发Web前端项目时，我们脱离不了第三方 npm 包的使用。当引用的 npm 包没有被编译成 ES5，或者编译的 ES5 目标浏览器版本比你项目本身的要求的目标浏览器版本高（比如：npm 包编译的ES5浏览器版本不支持 IE 11， 但是你的工程却要支持 IE11），那么我么希望工程在打包编译的时候，应该把引用的这个npm包（ 在node_modules下）一起编译为目标浏览器支持的ES5代码。

使用Webpack 工具，默认情况下工程源代码目录下的 ES6 代码会被编译为指定目标浏览器支持的 ES5（不一定：如果目标浏览器版本很高，本身就支持 ES6，则不会转换为ES5，所以这里说的是一般情况），但是 node_modules 下的 ES6代码则不会。

## 如何：编译 node_modules 下包里的代码

使用Webpack工具构建，需要明确指定 babel（使用babel 7+）配置：

1. 使用 babel.config.json （不能使用 .babelrc）

   > https://babeljs.io/docs/en/configuration#babelconfigjson  
   >
   > ## What's your use case?
   >
   > - You are using a monorepo?
   > - You want to compile `node_modules`?
   >
   > > [`babel.config.json`](https://babeljs.io/docs/en/configuration#babelconfigjson) is for you!

2. webpack配置文件(通常名字为 webpack.config.js)里 babel-loader 的include明确包含 npm包的目录，如: `node_modules/<包目录>`

babel.config.json 和 webpack.config.js 通常都位于项目根目录

### babel.config.json 例子

```json
{
  "presets": [
    [
      "@babel/preset-env",
      {
        "modules": false,
        "useBuiltIns": "usage",
        "corejs": "3"
      }
    ]
  ],
  "plugins": [
    [	
      "@babel/plugin-transform-runtime",
      {
        "corejs": 3
      }
    ]
  ]
}
```



## webpack.config.js 例子（片段）

```js
const path = require('path');

module.exports = {
  ...
  module:{
    rules:[
      {
        test: /\.js$/,
        use:'babel-loader',
        include: [
          path.resolve(__dirname, 'src'),
            path.resolve(__dirname, 'node_modules/[要编译的NPM包目录]'),
        ]
      }
    ]
  }
}
...
```

3. package.json 的 browserslist 默认值如下：

```json
 ....
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  ....
```

CRA 默认生成如上的目标浏览器配置，` 2022年12月25日` ，通过 `npx browserslist` 查看该配置，包括 IE 11

4. 写一个 js入口文件，调用 npm 包下某个 IE 11 不支持的特性（如：Array.includes）。

执行你的 `build` 看看目标代码是否生成了 `Array.includes`的 polyfill 代码？然后尝试修改 package.json：将 >0.2% 修改为 1%，`npx browserslist` 检查目标浏览器不再需要 IE11支持，此时再次运行 `build`，看看目标代码是否少了很多(polyfill)，Array.includes 的 polyfill 是不是也没有了？

## 基于 CRA 的 react 项目如何配置使支持：编译node_modules 下包里的代码

乍一看，这根本不是个问题，因为CRA 也使用 webpack 构建项目，修改上述配置应该可以达到目的。不过，由于CRA创建的工程封装了webpack配置，想要修改具体配置，需要执行`npm run eject`后进行修改。

### 1. 不要编译 node_modules目录下的 ES6

CRA默认编译 node_modules下ES6包。想要不编译它，运行命令`npm run eject`， 产生config目录如下：

```
onfig/
├── env.js
├── getHttpsConfig.js
├── modules.js
├── paths.js
├── webpack
├── webpack.config.js
└── webpackDevServer.config.js
```

查看`webpack.config.js`的 babel-loader 的配置：

```diff
...
    module: {
      rules: [
        {
          oneOf: [
            {
              test: /\.(js|mjs)$/,
              exclude: [
                /@babel(?:\/|\\{1,2})runtime/,
+                /node_modules/
              ],
              loader: require.resolve('babel-loader'),
              ...
            }
          ]
        }
    ].filter(Boolean),
             
```

增加行 `/node_modules/` ，再运行构建，就不会编译 node_modules 目录下的 ES6文件了

### 2. 本节有待商榷

使用工具链 react-app-rewired 和 customize-cra： 

1. 安装 [react-app-rewired](https://www.npmjs.com/package/react-app-rewired)：仅配置想要修改的 webapack 配置项；
2. 安装  [customize-cra](https://www.npmjs.com/package/customize-cra)：基于 react-app-wired，将 webpack 配置项分组配置好，开箱即用，并提供进一步定制；

**开始配置**

1. babel.config.json 同前步骤 1；
2. webpack 配置转移到了项目根目录下的 config-overrides.js 文件里。

```js
const { override, getBabelLoader, babelInclude } = require("customize-cra");
const path = require('path');

module.exports = {
  webpack: override(
    babelInclude([
      path.resolve("src"), // make sure you link your own source
      path.resolve("node_modules/[NPM包名]"),
    ]),

    (config, env) => {
      getBabelLoader(config).options.configFile = path.resolve(__dirname, "babel.config.json");
      return config;
    }
  )
};
```
3. 同前步骤 3；
4. 同前步骤 4。

采用同前的测试方法，尝试切换目标浏览器版本，看是否得到同样的效果？

## 总结

想成功完成这个实验，有几个关键点：

1. 配置 config-overrides.js 时，仅仅配置 include 会发现 babel.config.json不生效。不知出于什么目的，CRA 默认 babel-loader配置关闭了 configFile，需要开启 

   ```js
   getBabelLoader(config).options.configFile = path.resolve(__dirname, "babel.config.json");
   ```
   
2. 测试 js 不能用 React的JSX！因为 JSX 预编译出来的 js 本身依赖了很多 ES6 方法，包括 Array.includes，即使没有任何上述 webpack配置，只要目标浏览里包括 IE 11（见package.json里的 browserslist），它就会创建 IE 11的polyfill，从而导致误解。
